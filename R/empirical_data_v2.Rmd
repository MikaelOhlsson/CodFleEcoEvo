---
title: "Cod-Flounder empirical data"
date: "10/31/2024"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    self_contained: true
    mode: selfcontained
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, message = FALSE)
library(factoextra)
library(ggh4x)
library(ggpubr)
library(cowplot)
library(RColorBrewer)
library(tidyverse)
library(lubridate) #date formatting
library(raster)
#library(patchwork)
library(abdiv) #Morisita fn
library(FSA) #Age-Length key conv

theme_set(theme_bw())
theme_update(panel.grid = element_blank(),
             strip.background = element_rect(fill = "white", colour = "black"))
```

## Loading data

```{r Loading, message = FALSE}

# Only used for the already outdated condition stuff, which we do not currently include in the manuscript anyway
dm <- read_csv(paste0("../data/old_stomach_data.csv")) 
shape <- shapefile("../data/shapefiles/ICES-StatRec-mapto-ICES-Areas/StatRec_map_Areas_Full_20170124.shp")
pts <- SpatialPoints(cbind(dm$lon, dm$lat), 
                     proj4string = CRS(proj4string(shape)))
dm$subdiv <- over(pts, shape)$Area_27

# Biomass index
cod_fle_index <- read_csv("../data/cod_fle_index.csv")

# Cod and flounder body size development. 
# Original data copied from Max BITS project folder. 
# May need to add part of that to the manuscript methods. 
cod_h <- read_csv("../data/cod_cpue_length_historical.csv") %>%
  filter(sub_div %in% c(25:28) &
           year >= 1978 & 
           year <= 2015 & 
           quarter %in% c(1,4) & 
           !is.na(length_class)
         ) |>
  summarise(length_bio_dens = sum(biomass_density), .by = c(year, length_class, sub_div)) |> 
  mutate(species = "cod") %>% 
  arrange(year, length_class)

cod_n <- read_csv("../data/cod_cpue_length.csv") %>%
  filter(sub_div %in% c(25:28) & 
           year >= 2016 & 
           quarter %in% c(1,4) &
           !is.na(length_class)
         ) %>%
  summarise(length_bio_dens = sum(biomass_density), 
            .by = c(year, length_class)) |> 
  mutate(species = "cod") %>% 
  arrange(year, length_class)

fle_h <- read_csv("../data/fle_cpue_length_historical.csv") %>%
  filter(sub_div %in% c(25:28) & 
           year >= 1978 & 
           year <= 2015 & 
           quarter %in% c(1,4) &
           !is.na(length_class)) %>%
  summarise(length_bio_dens = sum(biomass_density), .by = c(year, length_class)) |> 
  mutate(species = "flounder") %>% 
  arrange(year, length_class)

fle_n <- read_csv("../data/fle_cpue_length.csv") %>%
  filter(sub_div %in% c(25:28) & 
           year >= 2016 & 
           quarter %in% c(1,4) &
           !is.na(length_class)) %>%
  summarise(length_bio_dens = sum(biomass_density), .by = c(year, length_class)) |> 
  mutate(species = "flounder") %>% 
  arrange(year, length_class)

cod_fle_size <- bind_rows(cod_h, cod_n, fle_h, fle_n)


# Age-Length data (ICES DATRAS Age Length Key, dl 2024-10-11)
# Apparently quite uncertain data, and may open up for critizism if used.
age_length_df <- read_csv("../data/age_length_2024-10-11.csv")

# 2024-10-27 Newest stomach content data from Viktor
new_stom_data <- read_csv("../data/stomachs_CodFlecoevo_v2.csv") %>% 
  mutate(prey_weight_tot = rowSums(.[3:17])) %>% 
  filter(prey_weight_tot > 0) %>% #Remove cods with empty stomachs
  filter(prey_weight_tot < pred_weight) %>% #Remove cods where the cod weighs less than the stomach content
  mutate(prey_pred_ratio = prey_weight_tot / pred_weight) %>% 
  filter(quantile(prey_pred_ratio, 0.99) > prey_pred_ratio) #Remove upper 1% quantile of cods with heaviest stomach content to body weight ratio, as some outliers still have unrealistic stomach content weights. 

#Which year brackets to aggregate
year_brackets <- c(1962, 1978, 1990, 2000, 2008, 2014, 2023)
```

# Body size dist 95 quantile

Mean and 95-percentile body length data for cod and flounder (shown below with the biomass figure).

I've tried looking into the cyclic trends up to the mid-2000's, nothing seems strange with the data itself at least. 

```{r 95quant, fig.height = 2.8, fig.width = 6.5, out.width="80%"}

# Total density of hauls, used to calculate proportional density 
dens_prop <- cod_fle_size %>% 
  group_by(year, species) %>% #year_cat
  mutate(tot_density = sum(length_bio_dens)) %>% 
  ungroup() %>% 
  mutate(prop = length_bio_dens / tot_density)

# Q4 Mean length based on density of length classes
dens_mean <- dens_prop %>%
  group_by(species, year) %>%
  summarise(meanlength = sum(length_class * length_bio_dens) / sum(length_bio_dens)) %>%
  ungroup()

# 95 percentile obtained with the cumulative sum of the proportion of each length class, with the 95-percentile set as the length closest to the 95-percentile. 
dens_95 <- dens_prop %>% 
  arrange(year, length_class) %>%
  group_by(year, species) %>% 
  mutate(cumprop = cumsum(prop)) %>% #filter(year == 1990 & species == "cod") %>% print(n = 200)
  filter(abs(cumprop-0.95) == min(abs(cumprop-0.95))) %>% 
  ungroup() 

gg_size_change <- dens_95 %>%
  left_join(dens_mean) %>%
  rename(p95_length = length_class,
         mean_length = meanlength) %>%
  pivot_longer(cols = c(p95_length, mean_length), 
               names_to = "length_var", 
               values_to = "length_val") %>%
  mutate(length_var = case_when(length_var == "mean_length" ~ "Mean",
                                length_var == "p95_length" ~ "95 percentile"),
         species = case_when(species == "cod" ~ "Cod",
                                species == "flounder" ~ "Flounder")) %>% 
  ggplot() +
  aes(x = year, y = length_val, color = length_var) +
  geom_point() +
  geom_smooth(formula = y~poly(x,2), method = "lm", se = F) +
  scale_color_manual(values = c(brewer.pal(n = 8, name = "Dark2")[2:3])) +
  #scale_y_continuous(limits = c(20,70)) +
  facet_wrap(.~species) + 
  labs(x = "Year", y = "Length (cm)", color = "Length Variable") +
  theme(legend.position = "bottom",
        legend.margin = margin(t = -10), 
        strip.text = element_blank()
        ) +
  NULL

#gg_size_change
  #ggsave("../fig/size_change.pdf", gg_size_change, height=2.8, width=5)
```

# Cod and flounder biomass

Note that biomass estimates here are actually the relative abundances instead of absolutes.

Currently biomass estimates are much more limited in years, and uncertain if we can easily expand this. We also don't really use cod and flounder biomass for anything other than some loose reasoning in the manuscript at the moment, so may want to scrap. And if so, of course remember to remove that significant part from the methods. 

```{r Cod_Fle_Index, out.width="80%", fig.width=6, fig.height=6}
gg_biomass <- cod_fle_index %>%
  dplyr::select(-`...1`) %>%
  ggplot() +
  aes(x = year, y = est_t/1000, ymax = upr_t/1000, ymin = lwr_t/1000) + #,
  geom_line(linewidth = 1) +
  geom_ribbon(alpha = 0.2, color = NA) +
  # scale_colour_manual(values = c("cornflowerblue", "darkseagreen")) +
  # scale_fill_manual(values = c("cornflowerblue", "darkseagreen")) +
  scale_x_continuous(limits = c(1978,2023)) +
  facet_wrap(.~species) +
  labs(x = "Year", y = "Biomass estimate (1000 t)", color = "Species", fill = "Species") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
#gg_biomass
gg_size_biomass <- plot_grid(gg_biomass, gg_size_change, 
                             ncol = 1, 
                             rel_heights = c(0.45,0.55), 
                             labels = c("A", "B")
)
gg_size_biomass
#ggsave("../fig/size_biomass.pdf", gg_size_biomass, height = 5, width = 6)
```

# Cod and flounder diet

Cod diet includes years 1963--2023. Flounder diet limited to years 2015-2023. Testing each year interval separately, aggregating weights for each type of food from year to interval, and then calculates the proportion of each diet type for each size class. Further divided into first and fourth quarters.

## Count data of number of cod stomach samples per size class

```{r  fig.height = 9, fig.width = 13, out.width="100%"}
new_stom_data %>% 
  mutate(predator_length_class = ifelse(
    predator_code == "COD",
    paste0("cod_", cut(pred_length, c(-Inf, 10, 15, 20, 25, 30, 40, 50,Inf))),
    paste0("flounder_", cut(pred_length, c(-Inf, 20,30,Inf)))),
    quarter = lubridate::quarter(month)
  ) %>%
  filter(quarter %in% c(1,4)) %>%
   mutate(predator_length_class = case_when(
    predator_length_class == "flounder_(-Inf,20]" ~ "Fle < 20",
    predator_length_class == "flounder_(20,30]" ~ "Fle 20-30",
    predator_length_class == "flounder_(30, Inf]" ~ "Fle 30+",
    predator_length_class == "cod_(-Inf,10]" ~ "Cod < 10",
    predator_length_class == "cod_(10,15]" ~ "Cod 10-15",
    predator_length_class == "cod_(15,20]" ~ "Cod 15-20",
    predator_length_class == "cod_(20,25]" ~ "Cod 20-25",
    predator_length_class == "cod_(25,30]" ~ "Cod 25-30",
    predator_length_class == "cod_(30,40]" ~ "Cod 30-40",
    predator_length_class == "cod_(40,50]" ~ "Cod 40-50",
    predator_length_class == "cod_(50, Inf]" ~ "Cod 50+")
  ) %>%
  mutate(quarter = case_when(quarter == "1" ~ "Q1",
                             quarter == "4" ~ "Q4")) %>%
  mutate(predator_code = case_when(predator_code == "COD" ~ "Cod",
                                   predator_code == "FLE" ~ "Flounder")) %>%
  group_by(predator_code, year, quarter) %>% 
  count(predator_length_class) %>% 
  ggplot() + 
  aes(x = year, y = n, fill = predator_length_class) + 
  geom_col(position = "stack") + 
  scale_fill_brewer(palette = "Paired") +
  scale_x_continuous(breaks = scales::extended_breaks(n = 60  / 5), 
                     expand = expansion(add = 0.5)) +
  facet_grid(quarter ~ predator_code, scales = "free_x", space = "free_x") +
  labs(fill = "Length (cm)", x = "Year", y = "Number of stomach samples") +
  theme(axis.text.x = element_text(angle = 35, hjust = 1, vjust = 1),
        legend.position = "bottom") +
  NULL
```

## Stomach data visualization

```{r fig.width=15, fig.height=8, out.width="100%"}

#For cleaner naming of some plots
StomLabelling <- function(df){
  df %>% 
        mutate(predator_length_class = case_when(
    predator_length_class == "flounder_(-Inf,20]" ~ "< 20",
    predator_length_class == "flounder_(20,30]" ~ "20-30",
    predator_length_class == "flounder_(30, Inf]" ~ "30+",
    predator_length_class == "cod_(-Inf,10]" ~ "< 10",
    predator_length_class == "cod_(10,15]" ~ "10-15",
    predator_length_class == "cod_(15,20]" ~ "15-20",
    predator_length_class == "cod_(20,25]" ~ "20-25",
    predator_length_class == "cod_(25,30]" ~ "25-30",
    predator_length_class == "cod_(30,40]" ~ "30-40",
    predator_length_class == "cod_(40,50]" ~ "40-50",
    predator_length_class == "cod_(50, Inf]" ~ "50+")
  ) %>%
  mutate(year_agg = case_when(
    year_agg == "(1962,1978]" ~ "1962-1978",
    year_agg == "(1978,1990]" ~ "1979-1990",
    year_agg == "(1990,2000]" ~ "1991-2000",
    year_agg == "(2000,2008]" ~ "2001-2008",
    year_agg == "(2008,2014]" ~ "2009-2014",
    year_agg == "(2014,2023]" ~ "2015-2023")
  ) %>%
  mutate(quarter = case_when(quarter == "1" ~ "Q1",
                             quarter == "4" ~ "Q4")) %>%
  mutate(predator_code = case_when(predator_code == "COD" ~ "Cod",
                                   predator_code == "FLE" ~ "Flounder"))
}

stom_count_data <- new_stom_data %>% 
  mutate(year_agg = as.character(cut(year, year_brackets, dig.lab = 10)),
         quarter = lubridate::quarter(month)) %>% 
  filter(quarter %in% c(1,4)) %>%
  mutate(predator_length_class = ifelse(predator_code == "COD",
                                        paste0("cod_", cut(pred_length, c(-Inf, 10, 15, 20, 25, 30, 40, 50,Inf))),
                                        paste0("flounder_", cut(pred_length, c(-Inf, 20,30,Inf))))) %>%
  dplyr::select(predator_code, year_agg, quarter, predator_length_class, pred_ID) %>%
  distinct() %>%
  group_by(predator_code, year_agg, quarter, predator_length_class) %>%
  count() %>% 
  ungroup() %>%
  StomLabelling()
  


gg_stom <- new_stom_data %>% 
  pivot_longer(cols = c(3:17), names_to = "species_group", values_to = "prey_weight") %>%
  mutate(year_agg = as.character(cut(year, year_brackets, dig.lab = 10))) %>%
  mutate(quarter = lubridate::quarter(month)) %>% 
  filter(quarter %in% c(1,4)) %>%
  mutate(predator_length_class = ifelse(predator_code == "COD",
                                        paste0("cod_", cut(pred_length, c(-Inf, 10, 15, 20, 25, 30, 40, 50,Inf))),
                                        paste0("flounder_", cut(pred_length, c(-Inf, 20,30,Inf))))) %>%
  group_by(pred_ID, predator_code, year_agg, quarter, 
           predator_length_class) %>%
  mutate(prey_weight_rel = prey_weight / prey_weight_tot) %>% 
  ungroup(pred_ID) %>%
  group_by(species_group, .add = T) %>%
  summarise(prey_rel_mean = sum(prey_weight_rel, na.rm = T)) %>% 
  ungroup(species_group) %>%
  mutate(prey_rel_norm = prey_rel_mean / sum(prey_rel_mean, na.rm = T)) %>%
  ungroup() %>%
  StomLabelling() %>%
  ggplot() +
  aes(x = predator_length_class, y = prey_rel_norm, fill = species_group) +
  geom_col() +
  geom_text(data = stom_count_data,
            mapping = aes(x = predator_length_class, y = 1.05, label = n),
            inherit.aes = F, size = 2.75) +
  scale_fill_manual(values = c(brewer.pal(name="Paired", n = 12),
                               brewer.pal(name="Dark2", n = 3))[1:15]) +
  facet_nested(quarter ~ predator_code + year_agg, 
               scales = "free", space = "free") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        legend.position = "bottom") +
  labs(fill = "Species Group", x = "Predator Length Class", 
       y = "Stomach content dietary proportions")
gg_stom
#ggsave(gg_stom, filename = "../fig/stom_cont_v2.pdf", height = 6, width = 18)
```



## Horn-Morisita Distance index

Morisita distance index value ranges 0-1, with 0 being identical and 1 fully different diets. Uses pairwise comparisons of two sets of vectors. *Horn* version to account for values being proportions instead of count data, as in our case with stomach content weight.

```{r fig.height = 7.3, fig.width = 8, out.width="100%"}
#year_brackets <- c(1962, 1978, 1990, 2000, 2007, 2014, 2023)

MoriFn <- function() {
  new_stom_df <- new_stom_data %>%
    pivot_longer(cols = c(3:17), names_to = "species_group", values_to = "prey_weight") %>%
    mutate(year_agg = as.character(cut(year, year_brackets, dig.lab = 10))) %>%
    mutate(quarter = lubridate::quarter(month)) %>% 
    filter(quarter %in% c(1,4)) %>%
    mutate(predator_length_class = ifelse(predator_code == "COD",
                                          paste0("cod_", cut(pred_length, c(-Inf, 10, 15, 20, 25, 30, 40, 50,Inf))),
                                          paste0("flounder_", cut(pred_length, c(-Inf, 20,30,Inf))))) %>%
    group_by(pred_ID, predator_code, year_agg, quarter, 
             predator_length_class) %>%
    mutate(prey_weight_rel = prey_weight / prey_weight_tot) %>% 
    ungroup(pred_ID) %>%
    group_by(species_group, .add = T) %>%
    summarise(prey_rel_mean = sum(prey_weight_rel, na.rm = T)) %>% 
    ungroup(species_group) %>%
    mutate(prey_rel_norm = prey_rel_mean / sum(prey_rel_mean, na.rm = T)) %>%
    ungroup()
  
  MoriExe <- function(x1, x2){
    horn_morisita(x1 %>% 
                    arrange(species_group) %>%
                    pull(w_sum), 
                  x2 %>% 
                    arrange(species_group) %>%
                    pull(w_sum)) %>% 
      round(3)
  }
  
  # df to combine with the stomach data to add missing prey items (and set weight to 0)
  all_sp_groups <- new_stom_df %>% 
    filter(!is.na(species_group)) %>%
    distinct(species_group) %>%
    mutate(w_sum = 0)
  
  # year intervals to manually add to flounder's missing intervals (while keeping weights as during 2015-2020)
  all_year_agg <- new_stom_df %>% 
    distinct(year_agg) %>%  
    pull(year_agg)
  
  # If a predator of a specific time period and size class is fully missing a prey,
  # the following tibble will be used to add an empty line for that prey, with stomach weight 0,
  # so that the right species will be matched later in the Morisita function
  w_empty <- new_stom_df %>% 
    filter(!is.na(species_group)) %>% #
    distinct(predator_length_class) %>% # For each size class,
    mutate(year_agg = list(all_year_agg)) %>% # Add year brackets (nested)
    unnest(year_agg) %>% # (expand year brackets)
    mutate(sp_empty = nest(all_sp_groups)) %>% # add filler prey data to use for missing values (w/ weight 0)
    unnest(sp_empty) %>%
    unnest(data) %>% # (2x expand)
    nest() %>% # nest all...
    slice(c(1,1)) %>% #... and duplicate...
    mutate(quarter = c(1,4)) %>% #...to add quarters 1 and 4
    unnest(data)
  
  # Set up the first half of the tibble, with time data and summarised prey weight information
  tmp_half <- 
    new_stom_df %>% 
    rename(w_sum = prey_rel_norm) %>%
    filter(!is.na(species_group)) %>% 
    group_by(predator_code) %>% 
    nest() %>%
    ungroup() %>%
    slice(c(1, rep(2, each = 6))) %>% # Manually duplicate flounder instances
    mutate(.r = 1:n()) %>%
    unnest(data) %>% 
    mutate(year_agg = case_when(.r == 1 ~ year_agg, # (leave cod data as is)
                                .r == 2 ~ "(1962,1978]", # properly attribute time periods for flounder duplicates
                                .r == 3 ~ "(1978,1990]",
                                .r == 4 ~ "(1990,2000]",
                                .r == 5 ~ "(2000,2008]",
                                .r == 6 ~ "(2008,2014]",
                                .r == 7 ~ "(2014,2023]")) %>%
    dplyr::select(-predator_code, -.r) %>%
    full_join(w_empty, by = c("predator_length_class", "species_group", "year_agg", "quarter")) %>%   # join with empty-values tibble to add missing prey instances
    dplyr::select(-w_sum.y) %>%
    rename(w_sum = w_sum.x) %>%
    mutate(w_sum = ifelse(is.na(w_sum), 0, w_sum)) %>% # set missing prey stomach weight to zero
    arrange(year_agg, quarter, predator_length_class) %>% 
    ungroup() %>%
    group_by(predator_length_class, year_agg, quarter) %>% 
    nest() # nest stomach weights
  
  # Use crossing() to generate tibble with all combinations of predator size classes and time periods
  tmp_half %>%
    tidyr::crossing(tmp_half, .name_repair = "unique") %>%
    rename(predator_length_class.x = predator_length_class...3,
           predator_length_class.y = predator_length_class...7,
           year_agg.x = year_agg...1,
           year_agg.y = year_agg...5,
           quarter.x = quarter...2,
           quarter.y = quarter...6,
           data.x = data...4,
           data.y = data...8) %>%
    arrange(year_agg.x, year_agg.y, predator_length_class.x, predator_length_class.y) %>%
    filter(year_agg.x == year_agg.y & quarter.x == quarter.y) %>% # Only interested in comparing cod and flounder during the same time period
    filter(str_detect(predator_length_class.x, "cod") & # Filter x and y cols to only include compare cod and flounder (no cod-cod etc)
             str_detect(predator_length_class.y, "flounder")) %>%
    mutate(mori_value = map2_dbl(data.x, data.y, MoriExe))   ####
}

mori_df <- MoriFn() %>% 
  rename(flounder = predator_length_class.y,
         cod = predator_length_class.x) %>%
  mutate(flounder = case_when(
    flounder == "flounder_(-Inf,20]" ~ "< 20",
    flounder == "flounder_(20,30]" ~ "20-30",
    flounder == "flounder_(30, Inf]" ~ "30+")) %>%
  mutate(cod = case_when(
    cod == "cod_(-Inf,10]" ~ "< 10",
    cod == "cod_(10,15]" ~ "10-15",
    cod == "cod_(15,20]" ~ "15-20",
    cod == "cod_(20,25]" ~ "20-25",
    cod == "cod_(25,30]" ~ "25-30",
    cod == "cod_(30,40]" ~ "30-40",
    cod == "cod_(40,50]" ~ "40-50",
    cod == "cod_(50, Inf]" ~ "50+")) %>%
  mutate(year_agg.x = case_when(year_agg.x == "(1962,1978]" ~ "1962-1978",
                           year_agg.x == "(1978,1990]" ~ "1979-1990",
                           year_agg.x == "(1990,2000]" ~ "1991-2000",
                           year_agg.x == "(2000,2008]" ~ "2001-2008",
                           year_agg.x == "(2008,2014]" ~ "2009-2014",
                           year_agg.x == "(2014,2023]" ~ "2015-2023")) %>%
  mutate(quarter.x = case_when(quarter.x == "1" ~ "Q1",
                               quarter.x == "4" ~ "Q4")) 
#For doing one Quarter at the time
gg_mori_q1 <- mori_df %>%
  filter(quarter.x == "Q1") %>%
  ggplot() +
  aes(y = cod, 
      x = flounder, 
      fill = mori_value, 
      label = mori_value) +
  geom_tile() +
  scale_fill_gradient2(low = "lightgreen", mid = "steelblue2", high = "darkred", midpoint = 0.72) +
  facet_wrap(year_agg.x~., ncol = 6) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        legend.position = "bottom",
        legend.margin = margin(t=-7)) +
  labs(fill = "Horn-Morisita dietary \ndistance index", y = "Cod length (cm)", x = "Flounder length (cm)") +
  coord_fixed()

#gg_mori_q1
#ggsave("../fig/diet_mori_q1.pdf", gg_mori_q1, height = 4.5, width = 8)

#Both quarters
gg_mori_v2 <- mori_df %>%
  #filter(quarter.x == "Q4") %>%
  ggplot() +
  aes(y = cod, 
      x = flounder, 
      fill = mori_value, 
      label = mori_value) +
  geom_tile() +
  scale_fill_gradient2(low = "lightgreen", mid = "steelblue2", high = "darkred", midpoint = 0.72) +
  facet_grid(quarter.x~year_agg.x) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        legend.position = "bottom",
        legend.margin = margin(t=-7)) +
  labs(fill = "Horn-Morisita dietary \ndistance index", y = "Cod length (cm)", x = "Flounder length (cm)") +
  coord_fixed()

gg_mori_v2
#ggsave("../fig/diet_mori_v2.pdf", gg_mori_q4, height = 7.3, width = 8)

```


# Dietary fish/invertebrate proportions

(new data)

Follows cod's dietary proportion of fish and invertebrates over the years 1993-2023.

Cod dietary transition from invertebrates to fish diet over time, divided in arbitrary cod length classes.

```{r fig.height = 4, fig.width = 7, out.width="100%"}
gg_invert_fish <- new_stom_data %>%
    mutate(year_agg = as.character(cut(year, year_brackets, dig.lab = 10))) %>%
    mutate(quarter = lubridate::quarter(month)) %>% 
    filter(quarter %in% c(1,4) & 
             pred_length > 10 & predator_code == "COD") %>%
    mutate(predator_length_class = ifelse(predator_code == "COD",
                                          paste0("cod_", cut(pred_length, c(10, 20, 25, 30, 40, 50,Inf))),
                                          paste0("flounder_", cut(pred_length, c(-Inf, 20,30,Inf))))) %>%
  mutate(invert = Amphipoda + `other Arthropods` + `other invert` + Polychaeta + Bivalvia + Mysidae + `Saduria entomon`,
         fish = `other Chord` + Clupeidae + `Clupea harengus` + `Gadus morhua` + `Sprattus sprattus` + `Platichthys flesus` + Gobiidae) |>  #Not including specific `other`, as it only includes plant material, non-biological material and unidentified prey
  dplyr::select(invert, fish, year, predator_length_class) |>  #pred_size_class
  mutate(invert = invert / (invert + fish),
         fish = 1 - invert,
         .by = c(year, predator_length_class)) |> 
  summarise(invert = sum(invert, na.rm = T),
            fish = sum(fish, na.rm = T),
            .by = c(year, predator_length_class)) |>
  mutate(invert_prop = invert / (invert + fish),
         fish_prop = fish / (invert + fish)) |> 
  pivot_longer(c("invert_prop", "fish_prop"), 
               names_to = "prey", 
               values_to = "weight_prop") |> 
  mutate(predator_length_class = case_when(
    predator_length_class == "cod_(-Inf,10]" ~ "< 10",
    predator_length_class == "cod_(10,20]" ~ "10-20",
    predator_length_class == "cod_(20,25]" ~ "20-25",
    predator_length_class == "cod_(25,30]" ~ "25-30",
    predator_length_class == "cod_(30,40]" ~ "30-40",
    predator_length_class == "cod_(40,50]" ~ "40-50",
    predator_length_class == "cod_(50,Inf]" ~ "50+"),
    prey = case_when(
      prey == "fish_prop" ~ "Fish",
      prey == "invert_prop" ~ "Invertebrate"
    )) %>%
  ggplot(aes(year, weight_prop, color = prey)) +
  geom_smooth(formula = y~s(x, k=4), method = "gam", se = FALSE) +
  geom_point() +
  #geom_vline(xintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("steelblue", "darkgoldenrod2")) +
  facet_wrap(predator_length_class~., scales = "free") + 
  theme(legend.position = "bottom", legend.margin = margin(t = -10)) +
  labs(x = "Year", y = "Dietary weight proportion", color = "Prey type") +
  NULL
gg_invert_fish
#ggsave("../fig/diet_transition_v2.pdf", gg_invert_fish, height = 4.5, width = 7)
```

# Age-Length and Age-Weight

Good trends, but unfortunately the data seems a bit sketchy as the actual age-determination is apparently quite uncertain when growth is poor, i.e. most of the recent years. Hence, we currently only refer to Mion et al 2021 and ICES 2022 regarding these trends in the discussion. 

Facet numbers indicate each respective age class, cut off at 9 due to very few samples above that age. 

```{r}
gg_age_length <- age_length_df %>% 
  filter(Area %in% c(25:28) &
         between(Age, 1, 9) &
           LngtClass < 1800 &
           Species == "Gadus morhua" &
           !is.na(IndWgt) &
           IndWgt > 0 &
           Country %in% c("SE", "DE", "PL")) %>% 
  group_by(Year, Species, Age, LngtClass, IndWgt) %>%
  summarise(CANoAtLngt = sum(CANoAtLngt)) %>%
  slice(rep(1:n(), times = CANoAtLngt)) %>%
  ungroup(LngtClass, IndWgt) %>%
  mutate(nAge = n()) %>%
  filter(nAge > 5) %>%
  summarise(meanLength = mean(LngtClass),
            meanWeight = mean(IndWgt)) %>%
  ggplot() +
  aes(x = Year, y = meanLength / 10) + # /10 for cm
  geom_point(alpha = 1) +
  geom_smooth(formula = y~poly(x,2), method = "lm", se = FALSE) +
  facet_wrap(.~Age, scales = "free_y") +
  labs(y = "Mean Length (cm)")
gg_age_length
#ggsave("../fig/age_length.pdf", gg_age_length, height = 5, width = 6)

gg_age_weight <- age_length_df %>% 
  filter(Area %in% c(25:28) &
         between(Age, 1, 9) &
           LngtClass < 1800 &
           Species == "Gadus morhua" & #"Gadus morhua" "Platichthys flesus"
           !is.na(IndWgt) &
           IndWgt > 0) %>%  #filter(Year == 2007 & Age == 9) %>% arrange(LngtClass) %>% print(n=60) ## Weird measurements 2007?
  group_by(Year, Species, Age, LngtClass, IndWgt) %>%
  summarise(CANoAtLngt = sum(CANoAtLngt)) %>%
  slice(rep(1:n(), times = CANoAtLngt)) %>%
  ungroup(LngtClass, IndWgt) %>%
  mutate(nAge = n()) %>%
  filter(nAge > 5) %>% 
  summarise(meanLength = mean(LngtClass),
            meanWeight = mean(IndWgt)) %>%
  ggplot() + 
  aes(x = Year, y = meanWeight) +
  geom_point(alpha = 1) +
  geom_smooth(formula = y~poly(x,2), method = "lm", se = FALSE) +
  facet_wrap(.~Age, scales = "free_y") +
  labs("Age facets", y = "Mean Weight (g)")
gg_age_weight
#ggsave("../fig/age_weight.pdf", gg_age_weight, height = 5, width = 6)
```

# Age-Length key probabilities

Plotting the probabilities of which length categories will belong to which age according to the Age-Length key.

```{r out.width="100%", fig.height = 8, fig.width = 13}
key_brackets <- c(1990, 1999, 2007, 2014, 2024)

propfun <- function(x){
  x %>% 
    with(table(LCat, Age)) %>%
    prop.table(margin = 1) %>% 
    as_tibble()
}

gg_al_all <- age_length_df %>%
  mutate(key_years = cut(Year, key_brackets, dig.lab = 10)) %>%
  filter(Species == "Gadus morhua" & Age > 0) %>%
  filter(LngtClass < 2000) %>% #removes a single erroneous outlier
  lencat(x = ~LngtClass, startcat = 30, w = 50) %>% 
  dplyr::select(LCat, Age, key_years) %>%
  as_tibble() %>%
  nest(data = c(LCat, Age)) %>%
  mutate(KeyTable = map(data, propfun)) %>%
  unnest(KeyTable) %>%
  mutate(LCat = as.numeric(LCat),
         Age = as.numeric(Age)) %>% 
  mutate(LCat = as.factor(LCat),
         Age = as.factor(Age)) %>%
  ggplot() +
  aes(y = Age, x = LCat, fill = n) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
#  coord_fixed() +
  facet_wrap(key_years~., scales = "free") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 35, hjust = 1, vjust = 1)) +
  labs(subtitle = "Probability of each specific length category being of a certain age", 
       title = "Age-Length key", 
       x = "Length category (mm)", 
       fill = "Probability")
gg_al_all
```

# Condition stuff (scrap?)

Still using old data. Currently not including any of it in the MS. Update to new data if we want to use something...

## Condition exploration

Does taking into account cod's condition (Fulton's K) correlate with their diet? First, how has cod condition developed over the years?

(Blue dashed line = Good, Red dotted line = Bad)

```{r fig.height = 12, fig.width = 14, out.width="100%"}
cond_df <- dm |> 
  mutate(quarter = lubridate::quarter(month),
         invert = saduria + other + other_invert,
         fish = herring + sprat + other_fish) |> 
  filter(subdiv != "3.d.24") |> #%in% c("3.d.28.2", "3.d.25")) |> 
  filter(quarter %in% c(1, 4)) |> 
  filter(pred_length > 10) |> 
  #filter(pred_weight > 100) |> 
  mutate(FultonK = 100 * pred_weight / (pred_length^3)) |> 
  filter(between(FultonK, 0.5, 1.75)) |> 
  mutate(YearAgg = cut(year, c(1963, 1978, 1990, 2000, 2010, 2014, 2023))) |> 
  mutate(pred_size_class = paste0("cod_", cut(pred_length, c(10, 15, 20, 25, 30, 40, 50,Inf)))) |> 
  dplyr::select(pred_ID, YearAgg, pred_size_class, FultonK) |> 
  mutate(pred_size_class = case_when(
    pred_size_class == "cod_(-Inf,10]" ~ "< 10",
    pred_size_class == "cod_(10,15]" ~ "10-15",
    pred_size_class == "cod_(15,20]" ~ "15-20",
    pred_size_class == "cod_(20,25]" ~ "20-25",
    pred_size_class == "cod_(25,30]" ~ "25-30",
    pred_size_class == "cod_(30,40]" ~ "30-40",
    pred_size_class == "cod_(40,50]" ~ "40-50",
    pred_size_class == "cod_(50,Inf]" ~ "50+"))

# # # Fulton K distribution separated by length class and YearAgg facets # # #
cond_count <- cond_df |> 
  group_by(YearAgg, pred_size_class) |> 
  count() |> 
  mutate(n = paste0("n=",n))

cond_df |>   
  ggplot() +
  aes(x = FultonK) +
  geom_density() + 
  geom_vline(xintercept = 1, linetype = "dashed", color = "blue") +
  geom_vline(xintercept = 0.8, linetype = "dotted", color = "red") +
  geom_text(data = cond_count, aes(label = n, x = 1.62, y = 5.7)) +
  facet_grid(pred_size_class~YearAgg)  +
  NULL
```

## Condition vs length over time

Is there a trend of larger or smaller individuals having better or worse condition? Seems like a general trend over all sizes more depending on the time period:

```{r  fig.height = 5, fig.width = 12, out.width="100%"}
# # # Length x Fulton K --- individual based # # #
cond_year_count <- cond_df |> 
  group_by(YearAgg) |> 
  count() |> 
  mutate(n = paste0("n=", n))

dm |> 
  mutate(quarter = lubridate::quarter(month),
         invert = saduria + other + other_invert,
         fish = herring + sprat + other_fish) |> 
  filter(subdiv != "3.d.24") |> 
  filter(quarter %in% c(1, 4)) |> 
  filter(pred_length > 10) |> 
  mutate(FultonK = 100 * pred_weight / (pred_length^3)) |> 
  filter(between(FultonK, 0.5, 1.75)) |> 
  mutate(YearAgg = cut(year, c(1963, 1978, 1990, 2000, 2010, 2014, 2023))) |> 
  dplyr::select(pred_ID, YearAgg, pred_length, FultonK) |> 
  ggplot() +
  aes(x = pred_length, y = FultonK) +
  geom_point(alpha = 0.2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "darkgoldenrod2", size = 1) +
  geom_hline(yintercept = 0.8, linetype = "dashed", color = "red", size = 1) +
  geom_hline(yintercept = 1.2, linetype = "dashed", color = "green", size = 1) +
  geom_smooth(formula = y~s(x, k=5), method = "gam", se = FALSE) +
  geom_text(data = cond_year_count, aes(label = n, x = 100, y = 1.65)) +
  scale_y_continuous(breaks = c(0.6, 0.8, 1.0, 1.2, 1.4, 1.6)) +
  facet_wrap(.~YearAgg) + 
  labs(x = "Cod length (cm)", y = "Fulton's K condition index")
```

## Individual Fulton's K vs Proportion Invert:Fish

Is having higher or lower condition linked to having a higher proportion fish in the diet (compared to benthic diet)? Hard to visualize as a very large proportion if individuals have only either fish or invertebrate diets. No general trends I believe:

```{r fig.height = 8, fig.width = 11, out.width="100%"}
dm |> 
  mutate(quarter = lubridate::quarter(month),
         invert = saduria + other + other_invert,
         fish = herring + sprat + other_fish) |> 
  filter(subdiv != "3.d.24") |> #%in% c("3.d.28.2", "3.d.25")) |> 
  filter(quarter %in% c(1, 4)) |> 
  filter(pred_length > 10) |> 
  #filter(pred_weight > 100) |> 
  mutate(FultonK = 100 * pred_weight / (pred_length^3)) |> 
  filter(FultonK < 3 & FultonK > 0.25) |> 
  mutate(YearAgg = cut(year, c(1963, 1978, 1990, 2000, 2010, 2014, 2023))) %>%
  mutate(pred_size_class = paste0("cod_", cut(pred_length, c(10, 20, 25, 30, 40, 50,Inf)))) |>
  # mutate(pred_size_class = paste0("cod_", cut(pred_weight, c(100, 300, 600, 1000, 2500, 5000, Inf)))) |> 
  mutate(pred_cond_class = paste0(cut(FultonK, c(-Inf, 0.85, 0.95,  1.05, 1.15, Inf)))) |>
  dplyr::select(pred_ID, invert, fish, YearAgg, FultonK, pred_size_class, pred_cond_class) |>  #
  mutate(invert = invert / (invert + fish),
         fish = 1 - invert) |> 
  filter(!is.na(fish)) |> #remove empty stomachs
  ggplot() +
  aes(x = pred_cond_class, y = fish) +
  geom_boxplot(width = 0.3) +
  geom_jitter(alpha = 0.2) +
  #scale_y_continuous(limits = c(0,1)) +
  facet_grid(YearAgg~pred_size_class) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        strip.background = element_rect(fill = "white", colour = "black"),
        axis.text.x = element_text(angle = 30, hjust=1, vjust=1)) +
  labs(x = "Predator condition class (Fulton's K)", y = "Proportion fish in diet (weight)")
#ggsave("../fig/Prop_fish_vs_Condition.pdf", height = 8, width = 11)
```

## Number of empty stomachs

```{r fig.height = 4, fig.width = 8, out.width = "100%"}
dm |> 
  mutate(quarter = lubridate::quarter(month),
         invert = saduria + other + other_invert,
         fish = herring + sprat + other_fish) |> 
  mutate(stom_sum = invert + fish) |>
  mutate(fish_prop = fish / stom_sum) |> 
  filter(subdiv != "3.d.24") |> #%in% c("3.d.28.2", "3.d.25")) |> 
  filter(quarter %in% c(1, 4)) |> 
  filter(pred_length > 10) |> 
  mutate(YearAgg = cut(year, c(1963, 1978, 1990, 2000, 2010, 2014, 2023))) |> 
  mutate(pred_size_class = paste0("cod_", cut(pred_length, c(10, 20, 30, 40, 50,Inf)))) |>
  mutate(FultonK = 100 * pred_weight / (pred_length^3)) |> 
  filter(FultonK < 2 & FultonK > 0.25) |> 
  mutate(EmptyStomach = ifelse(stom_sum > 0, "not empty", "empty")) |> 
  ggplot(aes(x = year, fill = EmptyStomach)) +
  geom_bar() +
  facet_wrap(pred_size_class~.)
```

## Stomach content weight vs condition

Excluding empty stomachs.

```{r fig.height = 12, fig.width = 14, out.width="100%"}
stom_weight_df <- dm |> 
  mutate(quarter = lubridate::quarter(month),
         invert = saduria + other + other_invert,
         fish = herring + sprat + other_fish) |> 
  mutate(stom_sum = invert + fish) |>
  mutate(fish_prop = fish / stom_sum) |> 
  filter(subdiv != "3.d.24") |> #%in% c("3.d.28.2", "3.d.25")) |> 
  filter(quarter %in% c(1, 4)) |> 
  filter(pred_length > 10) |> 
  mutate(YearAgg = cut(year, c(1963, 1978, 1990, 2000, 2010, 2014, 2023))) |> 
  mutate(pred_size_class = paste0("cod_", cut(pred_length, c(10, 20, 30, 40, 50,Inf)))) |>
  mutate(FultonK = 100 * pred_weight / (pred_length^3)) |> 
  filter(FultonK < 2 & FultonK > 0.25 & stom_sum > 0)

ConditionVsStomachContentWeight <- function(){
  stomw_count <- stom_weight_df |> 
    group_by(YearAgg, pred_size_class) |> 
    count() %>%
    mutate(n = paste0("n=",n))
  
  stom_weight_df |> 
    ggplot() +
    aes(x = log(stom_sum), y = FultonK, color = fish_prop) +
    geom_point(alpha = 0.33) +
    geom_smooth(formula = y~x, method = "lm", se = F, color = "darkred") +
    stat_cor(label.x.npc = "left", label.y.npc = "top", vjust = 1, color = "black") +
    geom_text(data = stomw_count, aes(label = n, x = -Inf, y = -Inf), 
              hjust=-0.3, vjust=-0.3, inherit.aes = F) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    scale_color_gradient(low = "darkgoldenrod2", high = "steelblue") +
    facet_grid(YearAgg~pred_size_class, scales = "free") +
    labs(title = "Condition vs total stomach content weight",
         subtitle = "(excluding empty stomachs)",
         x = "log(total stomach content weight)",
         y = "Condition (Fulton's K)",
         color = "Stomach content\nfish proportion")
}
ConditionVsStomachContentWeight()
#ggsave("../fig/condition_vs_stom_cont_weight.pdf", width = 14, height = 12)
```

### Stomach weight distribution

Excluding empty stomachs.

```{r fig.height = 12, fig.width = 14, out.width="100%"}
# Stomach Weight Distribution
StomWeightDistribution <- function(){
  mean_stom_weight <- stom_weight_df |> 
    group_by(YearAgg, pred_size_class) |> 
    summarise(m_stom_w = mean(stom_sum)) |> 
    ungroup()
  
  stomw_count <- stom_weight_df |> 
    group_by(YearAgg, pred_size_class) |> 
    count() %>%
    mutate(n = paste0("n=",n))
  
  stom_weight_df |> 
    ggplot()+
    aes(x = log(stom_sum)) +
    geom_density() +
    geom_text(data = stomw_count, aes(label = n, x = -Inf, y = Inf), 
              hjust=-0.3, vjust=1.3, inherit.aes = F) +
    geom_vline(mean_stom_weight, mapping = aes(xintercept = log(m_stom_w)), linetype = "dashed") +
    facet_grid(YearAgg~pred_size_class, scales = "free")
}
StomWeightDistribution()
```

```{r}
stom_weight_df %>%
  ggplot() +
  aes(x = year, y = log(stom_sum), group = year, color = fish_prop) +
  geom_boxplot(color = "black") + 
  geom_jitter(alpha = 0.33) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_color_gradient(low = "darkgoldenrod2", high = "steelblue") +
  facet_wrap(.~pred_size_class, ncol = 1)
```

## Condition when empty stomach

Considering the positive trend with higher stomach content weight and higher condition, comparing empty stomachs to non-empty stomachs showed surprisingly little difference. 

```{r fig.height = 5, fig.width = 9, out.width="100%"}
# # # Condition of empty stomachs
EmptyStomachCondition <- function(){
  meanFilled <- dm |> 
    mutate(quarter = lubridate::quarter(month),
           invert = saduria + other + other_invert,
           fish = herring + sprat + other_fish) |> 
    mutate(stom_sum = invert + fish) |> 
    filter(subdiv != "3.d.24") |> #%in% c("3.d.28.2", "3.d.25")) |> 
    filter(quarter %in% c(1, 4)) |> 
    filter(pred_length > 10) |> 
    mutate(YearAgg = cut(year, c(1963, 1978, 1990, 1995, 2000, 2005, 2010, 2014, 2023))) |> 
    mutate(FultonK = 100 * pred_weight / (pred_length^3)) |> 
    filter(FultonK < 1.5 & FultonK > 0.5) |> 
    mutate(StomFilled = ifelse(stom_sum > 0, "yes", "no")) |> 
    group_by(YearAgg, StomFilled) |> 
    summarise(meanFilledCond = mean(FultonK))
    
  
  tmp <- dm |> 
    mutate(quarter = lubridate::quarter(month),
           invert = saduria + other + other_invert,
           fish = herring + sprat + other_fish) |> 
    mutate(stom_sum = invert + fish) |> 
    filter(subdiv != "3.d.24") |> #%in% c("3.d.28.2", "3.d.25")) |> 
    filter(quarter %in% c(1, 4)) |> 
    filter(pred_length > 10) |> 
    mutate(YearAgg = cut(year, c(1963, 1978, 1990, 1995, 2000, 2005, 2010, 2014, 2023))) |> 
    mutate(FultonK = 100 * pred_weight / (pred_length^3)) |> 
    filter(FultonK < 1.5 & FultonK > 0.5) %>%
    mutate(StomFilled = ifelse(stom_sum > 0, "yes", "no"))
 
 tmp |> 
    ggplot() + 
    aes(x = FultonK, color = StomFilled, fill = StomFilled) +
    geom_density(alpha = 0.5) +
    geom_vline(meanFilled, mapping = aes(xintercept = meanFilledCond, color = as.factor(StomFilled)), show.legend = F, size = 1) +
   scale_fill_manual(values = c("firebrick3", "chartreuse")) +
   scale_color_manual(values = c("firebrick4", "chartreuse2")) +
    facet_wrap(YearAgg~.) +
    labs(title = "Fulton's K distribution of cods with and without stomach content",
         color = "Stomach content", fill = "Stomach content")
}
EmptyStomachCondition()
```
